# Insight Forge - Backend

Sistema de apoio √† decis√£o com an√°lise de dados e gest√£o de estoque, desenvolvido com Spring Boot, JPA e autentica√ß√£o JWT.

## üìã Sum√°rio

- [Vis√£o Geral](#vis√£o-geral)
- [Tecnologias Utilizadas](#tecnologias-utilizadas)
- [Arquitetura do Projeto](#arquitetura-do-projeto)
- [Estrutura do Banco de Dados](#estrutura-do-banco-de-dados)
- [Configura√ß√£o e Instala√ß√£o](#configura√ß√£o-e-instala√ß√£o)
- [Seguran√ßa e Autentica√ß√£o](#seguran√ßa-e-autentica√ß√£o)
- [Endpoints da API](#endpoints-da-api)
- [Exemplos de Uso](#exemplos-de-uso)
- [Funcionalidades Especiais](#funcionalidades-especiais)
- [Estrutura de Pastas](#estrutura-de-pastas)
- [Troubleshooting](#troubleshooting)

## üéØ Vis√£o Geral

O **Insight Forge** √© um sistema backend robusto para apoio √† tomada de decis√µes empresariais, focado em:

- **Gest√£o de Produtos**: CRUD completo com categoriza√ß√£o e controle de estoque
- **Controle de Fornecedores**: Cadastro e gest√£o de fornecedores
- **Movimenta√ß√µes de Estoque**: Registro autom√°tico de entradas e sa√≠das com atualiza√ß√£o do saldo
- **Autentica√ß√£o Segura**: Sistema JWT com controle de roles (USER/ADMIN)
- **Importa√ß√£o/Exporta√ß√£o**: Suporte a arquivos Excel para opera√ß√µes em massa
- **Multi-tenant**: Dados isolados por usu√°rio para seguran√ßa

## üöÄ Tecnologias Utilizadas

### Backend Framework
- **Java 21** - Linguagem principal
- **Spring Boot 3.5.3** - Framework principal
- **Spring Security** - Autentica√ß√£o e autoriza√ß√£o
- **Spring Data JPA** - Persist√™ncia de dados
- **Hibernate** - ORM

### Banco de Dados
- **MySQL 8+** - Banco de dados relacional
- **HikariCP** - Pool de conex√µes

### Bibliotecas Auxiliares
- **Lombok** - Redu√ß√£o de boilerplate
- **JJWT 0.11.5** - Manipula√ß√£o de tokens JWT
- **Apache POI 5.4.0** - Manipula√ß√£o de arquivos Excel
- **BCrypt** - Criptografia de senhas

### Build e Deploy
- **Maven** - Gerenciamento de depend√™ncias
- **Maven Wrapper** - mvnw inclu√≠do no projeto

## üèóÔ∏è Arquitetura do Projeto

A aplica√ß√£o segue uma arquitetura em camadas bem definida:

```
br.edu.fatecgru.insight_forge/
‚îú‚îÄ‚îÄ config/              # Configura√ß√µes de seguran√ßa, CORS e JWT
‚îú‚îÄ‚îÄ controller/          # Controladores REST
‚îú‚îÄ‚îÄ converter/           # Conversores Entity ‚Üî DTO
‚îú‚îÄ‚îÄ dto/                # Objetos de transfer√™ncia de dados
‚îú‚îÄ‚îÄ model/              # Entidades JPA
‚îú‚îÄ‚îÄ repository/         # Reposit√≥rios de dados
‚îî‚îÄ‚îÄ service/            # Regras de neg√≥cio
```

### Padr√µes Implementados
- **Repository Pattern** - Para abstra√ß√£o de acesso a dados
- **DTO Pattern** - Para transfer√™ncia segura de dados
- **Service Layer** - Para l√≥gica de neg√≥cio
- **Dependency Injection** - Gerenciado pelo Spring
- **JWT Token-based Authentication** - Autentica√ß√£o stateless

## üóÑÔ∏è Estrutura do Banco de Dados

### Entidades Principais

#### UsuarioEntity (`tb_usuarios`)
```java
- id (Long, PK)
- nome (String, not null)
- email (String, unique, not null)
- password (String, BCrypt, not null)
- role (String: "USER" | "ADMIN")
- createdAt (LocalDateTime)
```

#### ProdutoEntity (`tb_produtos`)
```java
- id (Long, PK)
- nome (String, not null)
- preco (BigDecimal, not null)
- custo (BigDecimal)
- categoria (String)
- descricao (String)
- quantidadeEstoque (Integer)
- ativo (Boolean, default: true)
- fornecedor_id (FK ‚Üí FornecedorEntity)
- usuario_id (FK ‚Üí UsuarioEntity, not null)
```

#### MovimentacaoEntity (`tb_movimentacoes`)
```java
- id (Long, PK)
- produto_id (FK ‚Üí ProdutoEntity, not null)
- usuario_id (FK ‚Üí UsuarioEntity, not null)
- quantidadeMovimentada (Integer, not null)
- dataMovimentacao (LocalDate, not null)
- tipoMovimentacao (String: "COMPRA" | "VENDA")
```

#### FornecedorEntity (`tb_fornecedores`)
```java
- id (Long, PK)
- nome (String, not null)
- cnpj (String, unique)
- telefone (String)
- dataCadastro (LocalDate, not null)
```

### Relacionamentos
- **Usuario ‚Üí Produtos**: One-to-Many (isolamento por usu√°rio)
- **Usuario ‚Üí Movimentacoes**: One-to-Many (isolamento por usu√°rio)
- **Fornecedor ‚Üí Produtos**: One-to-Many
- **Produto ‚Üí Movimentacoes**: One-to-Many (hist√≥rico completo)

## ‚öôÔ∏è Configura√ß√£o e Instala√ß√£o

### Pr√©-requisitos
- Java 21 ou superior
- MySQL 8.0 ou superior
- Maven 3.6+ (ou usar mvnw inclu√≠do)

### Configura√ß√£o do Banco de Dados
1. Instalar e iniciar MySQL
2. Criar usu√°rio/senha conforme `application.properties`
3. O banco `insightforge_db` ser√° criado automaticamente

### Vari√°veis de Ambiente (Recomendado para Produ√ß√£o)
```properties
# Database
DB_URL=jdbc:mysql://localhost:3306/insightforge_db
DB_USERNAME=seu_usuario
DB_PASSWORD=sua_senha

# JWT
JWT_SECRET=sua_chave_secreta_super_forte_aqui

# Profiles
SPRING_PROFILES_ACTIVE=prod
```

### Instala√ß√£o

1. **Clone o reposit√≥rio**
```bash
git clone <url-do-repositorio>
cd insight-forge-backend
```

2. **Configure o banco de dados** (edite `src/main/resources/application.properties`)
```properties
spring.datasource.username=seu_usuario_mysql
spring.datasource.password=sua_senha_mysql
```

3. **Execute a aplica√ß√£o**
```bash
# Op√ß√£o 1: Usar Maven Wrapper (recomendado)
./mvnw spring-boot:run

# Op√ß√£o 2: No Windows
mvnw.cmd spring-boot:run

# Op√ß√£o 3: Build e execute o JAR
./mvnw clean package -DskipTests
java -jar target/insight-forge-0.0.1-SNAPSHOT.jar
```

4. **Acesso**
- API: `http://localhost:8080`
- Usu√°rio padr√£o criado automaticamente:
  - Email: `admin@insight.com`
  - Senha: `admin123`
  - Role: `ADMIN`

## üîê Seguran√ßa e Autentica√ß√£o

### Sistema JWT
- **Expira√ß√£o**: 24 horas
- **Algoritmo**: HS256
- **Claims inclu√≠dos**: id, name, email, role
- **Header requerido**: `Authorization: Bearer <token>`

### N√≠veis de Acesso
- **P√∫blico**: `/api/auth/login`, `/api/auth/register`
- **USER/ADMIN**: `/api/produtos/**`, `/api/fornecedores/**`, `/api/movimentacoes/**`
- **Apenas ADMIN**: `/api/usuarios/**`

### CORS
Configurado para aceitar requisi√ß√µes de `http://localhost:3000` (frontend)

### Isolamento de Dados
Cada usu√°rio s√≥ acessa seus pr√≥prios produtos e movimenta√ß√µes (multi-tenant por usu√°rio).

## üì° Endpoints da API

### üîë Autentica√ß√£o (`/api/auth`)

#### POST `/api/auth/register`
Registro de novo usu√°rio (role: USER)
```json
Request:
{
  "nome": "Jo√£o Silva",
  "email": "joao@email.com",
  "password": "senha123"
}

Response (200):
{
  "message": "Usu√°rio registrado com sucesso",
  "usuario": { ... }
}
```

#### POST `/api/auth/login`
Autentica√ß√£o e gera√ß√£o de token
```json
Request:
{
  "email": "admin@insight.com",
  "password": "admin123"
}

Response (200):
{
  "token": "eyJhbGciOiJIUzI1NiJ9...",
  "user": {
    "id": 1,
    "name": "Administrador",
    "email": "admin@insight.com",
    "role": "ADMIN"
  }
}
```

### üë§ Usu√°rios (`/api/usuarios`) - Apenas ADMIN

#### GET `/api/usuarios`
Lista todos os usu√°rios

#### GET `/api/usuarios/buscarUsuario/{id}`
Busca usu√°rio por ID

#### PUT `/api/usuarios/atualizarUsuario/{id}`
Atualiza dados do usu√°rio

#### DELETE `/api/usuarios/deletarUsuario/{id}`
Remove usu√°rio

#### POST `/api/usuarios/registrarAdmin`
Registra usu√°rio com role espec√≠fica
```json
Request:
{
  "nome": "Admin Novo",
  "email": "novo@admin.com",
  "password": "senha123",
  "role": "ADMIN"
}
```

### üì¶ Produtos (`/api/produtos`) - USER/ADMIN

#### POST `/api/produtos/criarProduto`
```json
Request:
{
  "nome": "Notebook Dell",
  "preco": 2500.00,
  "custo": 2000.00,
  "categoria": "Eletr√¥nicos",
  "descricao": "Notebook para trabalho",
  "quantidadeEstoque": 10,
  "ativo": true
}

Response (201): ProdutoDTO
```

#### GET `/api/produtos/listarProdutos`
Lista produtos do usu√°rio autenticado

#### GET `/api/produtos/listarCategorias`
Lista todas as categorias distintas

#### GET `/api/produtos/buscarProdutoPorId/{id}`
Busca produto espec√≠fico

#### GET `/api/produtos/buscarProdutoPorCategoria?categoria=Eletr√¥nicos`
Filtra produtos por categoria

#### GET `/api/produtos/buscarProdutoPorNome?nome=Notebook`
Busca produtos por nome (LIKE)

#### GET `/api/produtos/buscarProdutosAtivos?ativo=true`
Filtra produtos ativos/inativos

#### PUT `/api/produtos/atualizarProduto/{id}`
Atualiza produto existente

#### DELETE `/api/produtos/deletarProduto/{id}`
Remove produto

#### POST `/api/produtos/importarProdutos`
Upload de arquivo Excel (multipart/form-data)
- Campo: `file`
- Formato: `.xlsx`
- Colunas: Nome, Pre√ßo, Custo, Descri√ß√£o, Categoria, Quantidade

#### GET `/api/produtos/exportarProdutos`
Download de todos os produtos em Excel

### üè¢ Fornecedores (`/api/fornecedores`) - USER/ADMIN

#### POST `/api/fornecedores/criarFornecedor`
```json
Request:
{
  "nome": "Fornecedor ABC",
  "cnpj": "12.345.678/0001-90",
  "telefone": "(11) 98765-4321",
  "dataCadastro": "2024-01-15"
}
```

#### GET `/api/fornecedores/listarFornecedores`
Lista todos os fornecedores

#### GET `/api/fornecedores/buscarPorId/{id}`
Busca fornecedor espec√≠fico

#### PUT `/api/fornecedores/atualizarFornecedor/{id}`
Atualiza fornecedor

#### DELETE `/api/fornecedores/deletarFornecedor/{id}`
Remove fornecedor

### üìä Movimenta√ß√µes (`/api/movimentacoes`) - USER/ADMIN

#### POST `/api/movimentacoes/criarMovimentacao`
Registra movimenta√ß√£o (atualiza estoque automaticamente)
```json
Request:
{
  "produto": { "id": 1 },
  "quantidadeMovimentada": 5,
  "dataMovimentacao": "2024-01-15",
  "tipoMovimentacao": "VENDA"
}

Response (201): MovimentacaoDTO
```
> **Regras**: COMPRA aumenta estoque, VENDA diminui (valida disponibilidade)

#### GET `/api/movimentacoes/listarMovimentacoes`
Lista movimenta√ß√µes do usu√°rio

#### GET `/api/movimentacoes/buscarPorId/{id}`
Busca movimenta√ß√£o espec√≠fica

#### GET `/api/movimentacoes/filtrarPorTipo?tipo=VENDA`
Filtra por tipo de movimenta√ß√£o

#### GET `/api/movimentacoes/filtrarPorData?dataInicio=2024-01-01&dataFim=2024-01-31`
Filtra por per√≠odo

#### GET `/api/movimentacoes/filtrarPorProduto?produtoId=1`
Filtra por produto

#### PUT `/api/movimentacoes/atualizarMovimentacao/{id}`
Atualiza movimenta√ß√£o (recalcula estoque)

#### DELETE `/api/movimentacoes/deletarMovimentacao/{id}`
Remove movimenta√ß√£o

#### POST `/api/movimentacoes/importarMovimentacoes`
Import via Excel
- Colunas: Nome do Produto, Quantidade, Data, Tipo

#### GET `/api/movimentacoes/exportar*`
M√∫ltiplas op√ß√µes de exporta√ß√£o:
- `/exportarMovimentacoes` - Todas
- `/exportarMovimentacoesPorProduto?produtoId=1`
- `/exportarMovimentacoesPorCategoria?categoria=Eletr√¥nicos`
- `/exportarMovimentacoesPorData?dataInicio=...&dataFim=...`

### ü©∫ Health (`/api/health`)
#### GET `/api/health`
Status da API (requer autentica√ß√£o)

## üìù Exemplos de Uso

### Fluxo Completo com cURL

1. **Login**
```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@insight.com","password":"admin123"}'
```

2. **Criar Produto** (usando token recebido)
```bash
curl -X POST http://localhost:8080/api/produtos/criarProduto \
  -H "Authorization: Bearer SEU_TOKEN_AQUI" \
  -H "Content-Type: application/json" \
  -d '{"nome":"Mouse Gamer","preco":150.00,"categoria":"Perif√©ricos","quantidadeEstoque":20}'
```

3. **Registrar Venda**
```bash
curl -X POST http://localhost:8080/api/movimentacoes/criarMovimentacao \
  -H "Authorization: Bearer SEU_TOKEN_AQUI" \
  -H "Content-Type: application/json" \
  -d '{"produto":{"id":1},"quantidadeMovimentada":2,"dataMovimentacao":"2024-01-15","tipoMovimentacao":"VENDA"}'
```

## ‚ú® Funcionalidades Especiais

### üîÑ Controle Autom√°tico de Estoque
- **COMPRA**: Incrementa `quantidadeEstoque`
- **VENDA**: Decrementa `quantidadeEstoque` (valida disponibilidade)
- **Atualiza√ß√£o**: Recalcula ao editar/deletar movimenta√ß√µes

### üìä Import/Export Excel
- **Importa√ß√£o**: Produtos e movimenta√ß√µes via planilha
- **Exporta√ß√£o**: Dados filtrados em diversos formatos
- **Valida√ß√£o**: Produtos duplicados s√£o ignorados na importa√ß√£o

### üîí Isolamento Multi-tenant
- Cada usu√°rio v√™ apenas seus pr√≥prios dados
- Produtos e movimenta√ß√µes isolados por `usuario_id`
- Fornecedores compartilhados entre usu√°rios

### üéØ DTOs e Conversores
- Exposi√ß√£o segura de dados (sem rela√ß√µes circulares)
- Convers√£o autom√°tica Entity ‚Üî DTO
- Responses padronizadas

## üìÅ Estrutura de Pastas

```
src/
‚îú‚îÄ‚îÄ main/
‚îÇ   ‚îú‚îÄ‚îÄ java/br/edu/fatecgru/insight_forge/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DataInitializer.java        # Dados iniciais
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JwtAuthenticationFilter.java # Filtro JWT
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JwtUtil.java               # Utilit√°rios JWT
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SecurityConfig.java        # Configura√ß√£o Security
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ WebConfig.java            # Configura√ß√£o CORS
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthController.java        # Login/Register
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FornecedorController.java  # CRUD Fornecedores
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ HealthController.java      # Health Check
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MovimentacaoController.java # CRUD Movimenta√ß√µes
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProdutoController.java     # CRUD Produtos
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UsuarioController.java     # Admin Usu√°rios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ converter/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MovimentacaoConverter.java
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ProdutoConverter.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MovimentacaoDTO.java
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProdutoDTO.java
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ResultadoImportacaoMovimentacaoDTO.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ model/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FornecedorEntity.java
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MovimentacaoEntity.java
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProdutoEntity.java
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UsuarioEntity.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FornecedorRepository.java
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MovimentacaoRepository.java
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProdutoRepository.java
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UsuarioRepository.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FornecedorService.java
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MovimentacaoService.java
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProdutoService.java
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UsuarioService.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ InsightForgeApplication.java
‚îÇ   ‚îî‚îÄ‚îÄ resources/
‚îÇ       ‚îú‚îÄ‚îÄ application.properties
‚îÇ       ‚îî‚îÄ‚îÄ application_example.properties
‚îî‚îÄ‚îÄ test/
    ‚îî‚îÄ‚îÄ java/br/edu/fatecgru/insight_forge/
        ‚îî‚îÄ‚îÄ InsightForgeApplicationTests.java
```

## üîß Troubleshooting

### Problemas Comuns

#### 1. Erro de Conex√£o com Banco
```
Error: Communications link failure
```
**Solu√ß√£o**: Verificar se MySQL est√° rodando e credenciais est√£o corretas

#### 2. Token JWT Inv√°lido
```
401 Unauthorized
```
**Solu√ß√µes**:
- Verificar header `Authorization: Bearer <token>`
- Token pode ter expirado (24h)
- Refazer login para obter novo token

#### 3. Erro de Permiss√£o
```
403 Forbidden
```
**Solu√ß√£o**: Verificar se usu√°rio tem role adequada para o endpoint

#### 4. Estoque Insuficiente
```
400 Bad Request: "Estoque insuficiente"
```
**Solu√ß√£o**: Verificar quantidade dispon√≠vel antes de registrar venda

#### 5. Produto N√£o Encontrado na Importa√ß√£o
**Solu√ß√£o**: Verificar se produtos existem antes de importar movimenta√ß√µes

### Logs √öteis

#### Ativar Debug SQL
```properties
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
logging.level.org.hibernate.SQL=DEBUG
```

#### Ativar Debug Security
```properties
logging.level.org.springframework.security=DEBUG
```

### Configura√ß√µes de Desenvolvimento vs Produ√ß√£o

#### Desenvolvimento
```properties
spring.jpa.hibernate.ddl-auto=create-drop
spring.jpa.show-sql=true
```

#### Produ√ß√£o
```properties
spring.jpa.hibernate.ddl-auto=validate
spring.jpa.show-sql=false
jwt.secret=${JWT_SECRET}
spring.datasource.url=${DB_URL}
```

---

**Desenvolvido por**: Alan Marques Machado